if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}const n="https://monitor.sanli.cn:3000/api";__definePage("pages/index/index",((e,t)=>{const n=e.__vccOpts||e;for(const[a,i]of t)n[a]=i;return n})({data:()=>({deviceList:[{id:"13012345005",name:"DTU设备1"},{id:"13012345001",name:"DTU设备2"},{id:"13912345678",name:"DTU设备3"},{id:"13912345679",name:"DTU设备4"}],selectedIndex:0,deviceStatus:{isOnline:!1,dtuNo:"",deviceName:"",rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""},timer:null,onlineDevices:[]}),onLoad(){this.startPolling()},onUnload(){this.stopPolling()},methods:{onDeviceChange(e){this.selectedIndex=e.detail.value,this.getDeviceStatus()},startPolling(){this.getDeviceStatus(),this.timer=setInterval((()=>{this.getDeviceStatus()}),1e3)},stopPolling(){this.timer&&(clearInterval(this.timer),this.timer=null)},async getDeviceStatus(){try{const e=this.deviceList[this.selectedIndex].id,t=await uni.request({url:`${n}/online-dtus`,method:"GET"});if(t.data.success){const a=t.data.devices.map((e=>e.dtuNo)).includes(e);if(this.deviceStatus.isOnline=a,a){const t=await uni.request({url:`${n}/dtu-status/${e}`,method:"GET"});t.data.success&&(this.deviceStatus={...t.data.data,isOnline:a})}else this.deviceStatus={isOnline:!1,dtuNo:e,deviceName:this.deviceList[this.selectedIndex].name,rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""}}}catch(e){t("error","at pages/index/index.vue:182","获取设备状态失败:",e),uni.showToast({title:"获取设备状态失败",icon:"none"})}},async toggleRelay(e){const t=this.deviceList[this.selectedIndex].id;if(this.deviceStatus.isOnline)try{this.stopPolling();const a=await uni.request({url:`${n}/control/relay`,method:"POST",data:{dtuNo:t,command:e?"ON":"OFF"},header:{"content-type":"application/json"}});0===a.data.code?(this.deviceStatus.relayStatus=e?"闭合":"断开",uni.showToast({title:"操作成功",icon:"success"}),setTimeout((()=>{this.startPolling()}),1e3)):(this.startPolling(),uni.showToast({title:a.data.message||"控制失败",icon:"none"}))}catch(a){this.startPolling(),uni.showToast({title:"控制失败",icon:"none"})}else uni.showToast({title:"设备离线，无法控制",icon:"none"})}}},[["render",function(t,n,a,i,l,s){return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"device-select"},[e.createElementVNode("picker",{onChange:n[0]||(n[0]=(...e)=>s.onDeviceChange&&s.onDeviceChange(...e)),value:l.selectedIndex,range:l.deviceList,"range-key":"name"},[e.createElementVNode("view",{class:"picker"}," 当前设备: "+e.toDisplayString(l.deviceList[l.selectedIndex].name),1)],40,["value","range"])]),e.createElementVNode("view",{class:"status-panel"},[e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"设备状态:"),e.createElementVNode("text",{class:e.normalizeClass({online:l.deviceStatus.isOnline,offline:!l.deviceStatus.isOnline})},e.toDisplayString(l.deviceStatus.isOnline?"在线":"离线"),3)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"更新时间:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.rcvTime||"--"),1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"AB线电压:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.voltageAB||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"BC线电压:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.voltageBC||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"CA线电压:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.voltageCA||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"A相电流:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.currentA||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"B相电流:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.currentB||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"C相电流:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.currentC||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"用电量:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.energy||"--")+" kWh",1)]),e.createElementVNode("view",{class:"status-item"},[e.createElementVNode("text",null,"压力:"),e.createElementVNode("text",null,e.toDisplayString(l.deviceStatus.pressure||"--")+" MPa",1)])]),e.createElementVNode("view",{class:"control-panel"},[e.createElementVNode("view",{class:"relay-item"},[e.createElementVNode("text",null,"继电器状态: "+e.toDisplayString(l.deviceStatus.relayStatus||"--"),1),e.createElementVNode("switch",{checked:"闭合"===l.deviceStatus.relayStatus,onChange:n[1]||(n[1]=e=>s.toggleRelay(e.detail.value))},null,40,["checked"])])])])}]]));const a={onLaunch:function(){t("log","at App.vue:4","App Launch")},onShow:function(){t("log","at App.vue:7","App Show")},onHide:function(){t("log","at App.vue:10","App Hide")}};const{app:i,Vuex:l,Pinia:s}={app:e.createVueApp(a)};uni.Vuex=l,uni.Pinia=s,i.provide("__globalStyles",__uniConfig.styles),i._component.mpType="app",i._component.render=()=>{},i.mount("#app")}(Vue);
