if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((i=>t.resolve(e()).then((()=>i))),(i=>t.resolve(e()).then((()=>{throw i}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...i){uni.__log__?uni.__log__(e,t,...i):console[e].apply(console,[...i,t])}const i="https://monitor.sanli.cn:3000/api";__definePage("pages/index/index",((e,t)=>{const i=e.__vccOpts||e;for(const[n,s]of t)i[n]=s;return i})({data:()=>({deviceList:[],selectedIndex:0,deviceStatus:{isOnline:!1,dtuNo:"",deviceName:"",rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""},timer:null,onlineDevices:[],showPicker:!1}),onLoad(){this.fetchDeviceList().then((()=>{this.deviceList.length>0&&this.startPolling()}))},onUnload(){this.stopPolling()},computed:{formattedTime(){if(!this.deviceStatus.rcvTime)return"--";const e=new Date(this.deviceStatus.rcvTime),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${e.getFullYear()}/${t}/${i} ${n}:${s}:${a}`}},methods:{async fetchDeviceList(){try{const e=await uni.request({url:`${i}/devices`,method:"GET"});e.data.success?(this.deviceList=e.data.devices.map((e=>({id:e.DtuNo,name:e.DeviceName,isOnline:!1}))),await this.updateDevicesOnlineStatus()):uni.showToast({title:"获取设备列表失败",icon:"none"})}catch(e){t("error","at pages/index/index.vue:198","获取设备列表失败:",e),uni.showToast({title:"获取设备列表失败",icon:"none"})}},async onDeviceChange(e){this.selectedIndex=e.detail.value,await this.getDeviceStatus()},startPolling(){0!==this.deviceList.length&&(this.updateDevicesOnlineStatus(),this.getDeviceStatus(),this.timer=setInterval((()=>{this.updateDevicesOnlineStatus(),this.getDeviceStatus()}),1e3))},stopPolling(){this.timer&&(clearInterval(this.timer),this.timer=null)},async getDeviceStatus(){try{const e=this.deviceList[this.selectedIndex].id,t=await uni.request({url:`${i}/online-dtus`,method:"GET"});if(t.data.success){const n=t.data.devices.map((e=>e.dtuNo)).includes(e);if(this.deviceStatus.isOnline=n,n){const t=await uni.request({url:`${i}/dtu-status/${e}`,method:"GET"});t.data.success&&(this.deviceStatus={...t.data.data,isOnline:n})}else this.deviceStatus={isOnline:!1,dtuNo:e,deviceName:this.deviceList[this.selectedIndex].name,rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""}}}catch(e){t("error","at pages/index/index.vue:280","获取设备状态失败:",e),uni.showToast({title:"获取设备状态失败",icon:"none"})}},async toggleRelay(e){const t=this.deviceList[this.selectedIndex].id;if(this.deviceStatus.isOnline)try{this.stopPolling();const n=await uni.request({url:`${i}/control/relay`,method:"POST",data:{dtuNo:t,command:e?"ON":"OFF"},header:{"content-type":"application/json"}});0===n.data.code?(this.deviceStatus.relayStatus=e?"闭合":"断开",uni.showToast({title:"操作成功",icon:"success"}),setTimeout((()=>{this.startPolling()}),1e3)):(this.startPolling(),uni.showToast({title:n.data.message||"控制失败",icon:"none"}))}catch(n){this.startPolling(),uni.showToast({title:"控制失败",icon:"none"})}else uni.showToast({title:"设备离线，无法控制",icon:"none"})},showDeviceList(){this.showPicker=!0},hidePicker(){this.showPicker=!1},async selectDevice(e){this.selectedIndex=e,this.hidePicker(),await this.getDeviceStatus()},async updateDevicesOnlineStatus(){if(0!==this.deviceList.length)try{const e=await uni.request({url:`${i}/online-dtus`,method:"GET"});if(e.data.success){const t=e.data.devices.map((e=>e.dtuNo));this.deviceList=this.deviceList.map((e=>({...e,isOnline:t.includes(e.id)})))}}catch(e){t("error","at pages/index/index.vue:379","获取在线设备失败:",e)}}}},[["render",function(t,i,n,s,a,l){return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("view",{class:"device-select"},[e.createElementVNode("view",{class:"picker-button",onClick:i[0]||(i[0]=(...e)=>l.showDeviceList&&l.showDeviceList(...e))},[e.createElementVNode("text",{class:"device-label"},"当前设备:"),e.createElementVNode("text",{class:e.normalizeClass(["device-name",a.deviceList[a.selectedIndex].isOnline?"device-online":"device-offline"])},[e.createTextVNode(e.toDisplayString(a.deviceList[a.selectedIndex].name)+" ",1),e.createElementVNode("text",{class:"device-status"},e.toDisplayString(a.deviceList[a.selectedIndex].isOnline?"(在线)":"(离线)"),1)],2),e.createElementVNode("text",{class:"picker-arrow"},"▼")])]),a.showPicker?(e.openBlock(),e.createElementBlock("view",{key:0,class:"custom-picker",onClick:i[3]||(i[3]=e.withModifiers(((...e)=>l.hidePicker&&l.hidePicker(...e)),["stop"]))},[e.createElementVNode("view",{class:"picker-mask"}),e.createElementVNode("view",{class:"picker-content",onClick:i[2]||(i[2]=e.withModifiers((()=>{}),["stop"]))},[e.createElementVNode("view",{class:"picker-header"},[e.createElementVNode("text",null,"选择设备"),e.createElementVNode("text",{class:"picker-close",onClick:i[1]||(i[1]=(...e)=>l.hidePicker&&l.hidePicker(...e))},"×")]),e.createElementVNode("view",{class:"picker-body"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.deviceList,((t,i)=>(e.openBlock(),e.createElementBlock("view",{key:t.id,class:e.normalizeClass(["picker-item",t.isOnline?"picker-item-online":"picker-item-offline",a.selectedIndex===i?"picker-item-selected":""]),onClick:e=>l.selectDevice(i)},[e.createElementVNode("text",null,e.toDisplayString(t.name),1),e.createElementVNode("text",{class:"device-status-tag"},e.toDisplayString(t.isOnline?"在线":"离线"),1)],10,["onClick"])))),128))])])])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"container"},[0===a.deviceList.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-list"},[e.createElementVNode("text",null,"暂无可用设备")])):e.createCommentVNode("",!0),e.createElementVNode("view",{class:"status-panel"},[e.createElementVNode("view",{class:"status-item status-connection"},[e.createElementVNode("text",null,"设备状态:"),e.createElementVNode("text",{class:e.normalizeClass({online:a.deviceStatus.isOnline,offline:!a.deviceStatus.isOnline})},e.toDisplayString(a.deviceStatus.isOnline?"在线":"离线"),3)]),e.createElementVNode("view",{class:"status-item status-time"},[e.createElementVNode("text",null,"更新时间:"),e.createElementVNode("text",null,e.toDisplayString(l.formattedTime),1)]),e.createElementVNode("view",{class:"status-item voltage"},[e.createElementVNode("text",null,"AB线电压:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.voltageAB||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item voltage"},[e.createElementVNode("text",null,"BC线电压:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.voltageBC||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item voltage"},[e.createElementVNode("text",null,"CA线电压:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.voltageCA||"--")+" V",1)]),e.createElementVNode("view",{class:"status-item current"},[e.createElementVNode("text",null,"A相电流:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.currentA||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item current"},[e.createElementVNode("text",null,"B相电流:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.currentB||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item current"},[e.createElementVNode("text",null,"C相电流:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.currentC||"--")+" A",1)]),e.createElementVNode("view",{class:"status-item energy"},[e.createElementVNode("text",null,"用电量:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.energy||"--")+" kWh",1)]),e.createElementVNode("view",{class:"status-item pressure"},[e.createElementVNode("text",null,"压力:"),e.createElementVNode("text",null,e.toDisplayString(a.deviceStatus.pressure||"--")+" MPa",1)])]),e.createElementVNode("view",{class:"control-panel"},[e.createElementVNode("view",{class:"relay-item"},[e.createElementVNode("view",{class:"relay-status"},[e.createElementVNode("text",{class:"relay-label"},"继电器状态:"),e.createElementVNode("text",{class:e.normalizeClass(["relay-value","闭合"===a.deviceStatus.relayStatus?"relay-on":"relay-off"])},e.toDisplayString(a.deviceStatus.relayStatus||"--"),3)]),e.createElementVNode("switch",{checked:"闭合"===a.deviceStatus.relayStatus,onChange:i[4]||(i[4]=e=>l.toggleRelay(e.detail.value)),disabled:!a.deviceStatus.isOnline,class:"relay-switch"},null,40,["checked","disabled"])])])])],64)}]]));const n={onLaunch:function(){t("log","at App.vue:4","App Launch")},onShow:function(){t("log","at App.vue:7","App Show")},onHide:function(){t("log","at App.vue:10","App Hide")}};const{app:s,Vuex:a,Pinia:l}={app:e.createVueApp(n)};uni.Vuex=a,uni.Pinia=l,s.provide("__globalStyles",__uniConfig.styles),s._component.mpType="app",s._component.render=()=>{},s.mount("#app")}(Vue);
