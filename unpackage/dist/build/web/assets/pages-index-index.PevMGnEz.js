import{r as e,s as t,c as s,a,w as i,b as l,d as c,e as n,F as d,i as u,o,f as r,n as v,t as f,g as h,h as _,j as m}from"./index-DEzr18nA.js";const g="https://monitor.sanli.cn:3000/api";const S=((e,t)=>{const s=e.__vccOpts||e;for(const[a,i]of t)s[a]=i;return s})({data:()=>({deviceList:[],selectedIndex:0,deviceStatus:{isOnline:!1,dtuNo:"",deviceName:"",rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""},timer:null,onlineDevices:[],showPicker:!1}),onLoad(){this.fetchDeviceList().then((()=>{this.deviceList.length>0&&this.startPolling()}))},onUnload(){this.stopPolling()},computed:{formattedTime(){if(!this.deviceStatus.rcvTime)return"--";const e=new Date(this.deviceStatus.rcvTime),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),a=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${e.getFullYear()}/${t}/${s} ${a}:${i}:${l}`}},methods:{async fetchDeviceList(){try{const s=await e({url:`${g}/devices`,method:"GET"});s.data.success?(this.deviceList=s.data.devices.map((e=>({id:e.DtuNo,name:e.DeviceName,isOnline:!1}))),await this.updateDevicesOnlineStatus()):t({title:"获取设备列表失败",icon:"none"})}catch(s){console.error("获取设备列表失败:",s),t({title:"获取设备列表失败",icon:"none"})}},async onDeviceChange(e){this.selectedIndex=e.detail.value,await this.getDeviceStatus()},startPolling(){0!==this.deviceList.length&&(this.updateDevicesOnlineStatus(),this.getDeviceStatus(),this.timer=setInterval((()=>{this.updateDevicesOnlineStatus(),this.getDeviceStatus()}),1e3))},stopPolling(){this.timer&&(clearInterval(this.timer),this.timer=null)},async getDeviceStatus(){try{const t=this.deviceList[this.selectedIndex].id,s=await e({url:`${g}/online-dtus`,method:"GET"});if(s.data.success){const a=s.data.devices.map((e=>e.dtuNo)).includes(t);if(this.deviceStatus.isOnline=a,a){const s=await e({url:`${g}/dtu-status/${t}`,method:"GET"});s.data.success&&(this.deviceStatus={...s.data.data,isOnline:a})}else this.deviceStatus={isOnline:!1,dtuNo:t,deviceName:this.deviceList[this.selectedIndex].name,rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""}}}catch(s){console.error("获取设备状态失败:",s),t({title:"获取设备状态失败",icon:"none"})}},async toggleRelay(s){const a=this.deviceList[this.selectedIndex].id;if(this.deviceStatus.isOnline)try{this.stopPolling();const i=await e({url:`${g}/control/relay`,method:"POST",data:{dtuNo:a,command:s?"ON":"OFF"},header:{"content-type":"application/json"}});0===i.data.code?(this.deviceStatus.relayStatus=s?"闭合":"断开",t({title:"操作成功",icon:"success"}),setTimeout((()=>{this.startPolling()}),1e3)):(this.startPolling(),t({title:i.data.message||"控制失败",icon:"none"}))}catch(i){this.startPolling(),t({title:"控制失败",icon:"none"})}else t({title:"设备离线，无法控制",icon:"none"})},showDeviceList(){this.showPicker=!0},hidePicker(){this.showPicker=!1},async selectDevice(e){this.selectedIndex=e,this.hidePicker(),await this.getDeviceStatus()},async updateDevicesOnlineStatus(){if(0!==this.deviceList.length)try{const t=await e({url:`${g}/online-dtus`,method:"GET"});if(t.data.success){const e=t.data.devices.map((e=>e.dtuNo));this.deviceList=this.deviceList.map((t=>({...t,isOnline:e.includes(t.id)})))}}catch(t){console.error("获取在线设备失败:",t)}}}},[["render",function(e,t,g,S,p,y){const k=_,C=u,O=m;return o(),s(d,null,[a(C,{class:"device-select"},{default:i((()=>[a(C,{class:"picker-button",onClick:y.showDeviceList},{default:i((()=>[a(k,{class:"device-label"},{default:i((()=>[r("当前设备:")])),_:1}),a(k,{class:v(["device-name",p.deviceList[p.selectedIndex].isOnline?"device-online":"device-offline"])},{default:i((()=>[r(f(p.deviceList[p.selectedIndex].name)+" ",1),a(k,{class:"device-status"},{default:i((()=>[r(f(p.deviceList[p.selectedIndex].isOnline?"(在线)":"(离线)"),1)])),_:1})])),_:1},8,["class"]),a(k,{class:"picker-arrow"},{default:i((()=>[r("▼")])),_:1})])),_:1},8,["onClick"])])),_:1}),p.showPicker?(o(),l(C,{key:0,class:"custom-picker",onClick:c(y.hidePicker,["stop"])},{default:i((()=>[a(C,{class:"picker-mask"}),a(C,{class:"picker-content",onClick:t[0]||(t[0]=c((()=>{}),["stop"]))},{default:i((()=>[a(C,{class:"picker-header"},{default:i((()=>[a(k,null,{default:i((()=>[r("选择设备")])),_:1}),a(k,{class:"picker-close",onClick:y.hidePicker},{default:i((()=>[r("×")])),_:1},8,["onClick"])])),_:1}),a(C,{class:"picker-body"},{default:i((()=>[(o(!0),s(d,null,h(p.deviceList,((e,t)=>(o(),l(C,{key:e.id,class:v(["picker-item",e.isOnline?"picker-item-online":"picker-item-offline",p.selectedIndex===t?"picker-item-selected":""]),onClick:e=>y.selectDevice(t)},{default:i((()=>[a(k,null,{default:i((()=>[r(f(e.name),1)])),_:2},1024),a(k,{class:"device-status-tag"},{default:i((()=>[r(f(e.isOnline?"在线":"离线"),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})])),_:1},8,["onClick"])):n("",!0),a(C,{class:"container"},{default:i((()=>[0===p.deviceList.length?(o(),l(C,{key:0,class:"empty-list"},{default:i((()=>[a(k,null,{default:i((()=>[r("暂无可用设备")])),_:1})])),_:1})):n("",!0),a(C,{class:"status-panel"},{default:i((()=>[a(C,{class:"status-item status-connection"},{default:i((()=>[a(k,null,{default:i((()=>[r("设备状态:")])),_:1}),a(k,{class:v({online:p.deviceStatus.isOnline,offline:!p.deviceStatus.isOnline})},{default:i((()=>[r(f(p.deviceStatus.isOnline?"在线":"离线"),1)])),_:1},8,["class"])])),_:1}),a(C,{class:"status-item status-time"},{default:i((()=>[a(k,null,{default:i((()=>[r("更新时间:")])),_:1}),a(k,null,{default:i((()=>[r(f(y.formattedTime),1)])),_:1})])),_:1}),a(C,{class:"status-item voltage"},{default:i((()=>[a(k,null,{default:i((()=>[r("AB线电压:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.voltageAB||"--")+" V",1)])),_:1})])),_:1}),a(C,{class:"status-item voltage"},{default:i((()=>[a(k,null,{default:i((()=>[r("BC线电压:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.voltageBC||"--")+" V",1)])),_:1})])),_:1}),a(C,{class:"status-item voltage"},{default:i((()=>[a(k,null,{default:i((()=>[r("CA线电压:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.voltageCA||"--")+" V",1)])),_:1})])),_:1}),a(C,{class:"status-item current"},{default:i((()=>[a(k,null,{default:i((()=>[r("A相电流:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.currentA||"--")+" A",1)])),_:1})])),_:1}),a(C,{class:"status-item current"},{default:i((()=>[a(k,null,{default:i((()=>[r("B相电流:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.currentB||"--")+" A",1)])),_:1})])),_:1}),a(C,{class:"status-item current"},{default:i((()=>[a(k,null,{default:i((()=>[r("C相电流:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.currentC||"--")+" A",1)])),_:1})])),_:1}),a(C,{class:"status-item energy"},{default:i((()=>[a(k,null,{default:i((()=>[r("用电量:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.energy||"--")+" kWh",1)])),_:1})])),_:1}),a(C,{class:"status-item pressure"},{default:i((()=>[a(k,null,{default:i((()=>[r("压力:")])),_:1}),a(k,null,{default:i((()=>[r(f(p.deviceStatus.pressure||"--")+" MPa",1)])),_:1})])),_:1})])),_:1}),a(C,{class:"control-panel"},{default:i((()=>[a(C,{class:"relay-item"},{default:i((()=>[a(C,{class:"relay-status"},{default:i((()=>[a(k,{class:"relay-label"},{default:i((()=>[r("继电器状态:")])),_:1}),a(k,{class:v(["relay-value","闭合"===p.deviceStatus.relayStatus?"relay-on":"relay-off"])},{default:i((()=>[r(f(p.deviceStatus.relayStatus||"--"),1)])),_:1},8,["class"])])),_:1}),a(O,{checked:"闭合"===p.deviceStatus.relayStatus,onChange:t[1]||(t[1]=e=>y.toggleRelay(e.detail.value)),disabled:!p.deviceStatus.isOnline,class:"relay-switch"},null,8,["checked","disabled"])])),_:1})])),_:1})])),_:1}),a(C,{class:"copyright"},{default:i((()=>[a(k,null,{default:i((()=>[r("青岛三利智能动力有限公司")])),_:1}),a(k,null,{default:i((()=>[r("copyright 2025")])),_:1})])),_:1})],64)}],["__scopeId","data-v-047979bf"]]);export{S as default};
