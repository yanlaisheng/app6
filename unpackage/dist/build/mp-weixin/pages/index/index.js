"use strict";const e=require("../../common/vendor.js"),t={data:()=>({deviceList:[{id:"13012345005",name:"DTU设备1"},{id:"13012345001",name:"DTU设备2"},{id:"13912345678",name:"DTU设备3"},{id:"13912345679",name:"DTU设备4"}],selectedIndex:0,deviceStatus:{isOnline:!1,dtuNo:"",deviceName:"",rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""},timer:null,onlineDevices:[]}),onLoad(){this.startPolling()},onUnload(){this.stopPolling()},methods:{onDeviceChange(e){this.selectedIndex=e.detail.value,this.getDeviceStatus()},startPolling(){this.getDeviceStatus(),this.timer=setInterval((()=>{this.getDeviceStatus()}),1e3)},stopPolling(){this.timer&&(clearInterval(this.timer),this.timer=null)},async getDeviceStatus(){try{const t=this.deviceList[this.selectedIndex].id,i=await e.index.request({url:"http://118.190.202.38:3000/api/online-dtus",method:"GET"});if(i.data.success){const s=i.data.devices.map((e=>e.dtuNo)).includes(t);if(this.deviceStatus.isOnline=s,s){const i=await e.index.request({url:`http://118.190.202.38:3000/api/dtu-status/${t}`,method:"GET"});i.data.success&&(this.deviceStatus={...i.data.data,isOnline:s})}else this.deviceStatus={isOnline:!1,dtuNo:t,deviceName:this.deviceList[this.selectedIndex].name,rcvTime:"",voltageAB:"",voltageBC:"",voltageCA:"",currentA:"",currentB:"",currentC:"",energy:"",pressure:"",relayStatus:""}}}catch(t){console.error("获取设备状态失败:",t),e.index.showToast({title:"获取设备状态失败",icon:"none"})}},async toggleRelay(t){const i=this.deviceList[this.selectedIndex].id;if(this.deviceStatus.isOnline)try{this.stopPolling();const s=await e.index.request({url:"http://118.190.202.38:3000/api/control/relay",method:"POST",data:{dtuNo:i,command:t?"ON":"OFF"},header:{"content-type":"application/json"}});0===s.data.code?(this.deviceStatus.relayStatus=t?"闭合":"断开",e.index.showToast({title:"操作成功",icon:"success"}),setTimeout((()=>{this.startPolling()}),1e3)):(this.startPolling(),e.index.showToast({title:s.data.message||"控制失败",icon:"none"}))}catch(s){this.startPolling(),e.index.showToast({title:"控制失败",icon:"none"})}else e.index.showToast({title:"设备离线，无法控制",icon:"none"})}}};const i=e._export_sfc(t,[["render",function(t,i,s,a,n,c){return{a:e.t(n.deviceList[n.selectedIndex].name),b:e.o(((...e)=>c.onDeviceChange&&c.onDeviceChange(...e))),c:n.selectedIndex,d:n.deviceList,e:e.t(n.deviceStatus.isOnline?"在线":"离线"),f:n.deviceStatus.isOnline?1:"",g:n.deviceStatus.isOnline?"":1,h:e.t(n.deviceStatus.rcvTime||"--"),i:e.t(n.deviceStatus.voltageAB||"--"),j:e.t(n.deviceStatus.voltageBC||"--"),k:e.t(n.deviceStatus.voltageCA||"--"),l:e.t(n.deviceStatus.currentA||"--"),m:e.t(n.deviceStatus.currentB||"--"),n:e.t(n.deviceStatus.currentC||"--"),o:e.t(n.deviceStatus.energy||"--"),p:e.t(n.deviceStatus.pressure||"--"),q:e.t(n.deviceStatus.relayStatus||"--"),r:"闭合"===n.deviceStatus.relayStatus,s:e.o((e=>c.toggleRelay(e.detail.value)))}}]]);wx.createPage(i);
