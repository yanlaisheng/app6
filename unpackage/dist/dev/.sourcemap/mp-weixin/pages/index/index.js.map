{"version":3,"file":"index.js","sources":["pages/index/index.vue","F:/FDM下载/HBuilderX.4.65.2025051206/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvaW5kZXgvaW5kZXgudnVl"],"sourcesContent":["<template>\r\n    <view class=\"container\">\r\n        <!-- 设备选择区 -->\r\n        <view class=\"device-select\">\r\n            <picker @change=\"onDeviceChange\" :value=\"selectedIndex\" :range=\"deviceList\" range-key=\"name\">\r\n                <view class=\"picker\">\r\n                    当前设备: {{deviceList[selectedIndex].name}}\r\n                </view>\r\n            </picker>\r\n        </view>\r\n        \r\n        <!-- 设备状态显示区 -->\r\n        <view class=\"status-panel\">\r\n            <view class=\"status-item\">\r\n                <text>设备状态:</text>\r\n                <text :class=\"{'online': deviceStatus.isOnline, 'offline': !deviceStatus.isOnline}\">\r\n                    {{deviceStatus.isOnline ? '在线' : '离线'}}\r\n                </text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>更新时间:</text>\r\n                <text>{{deviceStatus.rcvTime || '--'}}</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>AB线电压:</text>\r\n                <text>{{deviceStatus.voltageAB || '--'}} V</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>BC线电压:</text>\r\n                <text>{{deviceStatus.voltageBC || '--'}} V</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>CA线电压:</text>\r\n                <text>{{deviceStatus.voltageCA || '--'}} V</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>A相电流:</text>\r\n                <text>{{deviceStatus.currentA || '--'}} A</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>B相电流:</text>\r\n                <text>{{deviceStatus.currentB || '--'}} A</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>C相电流:</text>\r\n                <text>{{deviceStatus.currentC || '--'}} A</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>用电量:</text>\r\n                <text>{{deviceStatus.energy || '--'}} kWh</text>\r\n            </view>\r\n            <view class=\"status-item\">\r\n                <text>压力:</text>\r\n                <text>{{deviceStatus.pressure || '--'}} MPa</text>\r\n            </view>\r\n        </view>\r\n        \r\n        <!-- 继电器控制区 -->\r\n        <view class=\"control-panel\">\r\n            <view class=\"relay-item\">\r\n                <view class=\"relay-status\">\r\n                    <text>继电器状态: </text>\r\n                    <text v-if=\"!isRelayLoading\">\r\n                        {{deviceStatus.relayStatus || '--'}}\r\n                    </text>\r\n                    <view v-else class=\"loading-icon\"></view>\r\n                </view>\r\n                <switch \r\n                    :checked=\"deviceStatus.relayStatus === '闭合'\"\r\n                    @change=\"toggleRelay\"\r\n                    :disabled=\"!deviceStatus.isOnline || isRelayLoading\"\r\n                    :style=\"{ opacity: (!deviceStatus.isOnline || isRelayLoading) ? 0.5 : 1 }\"\r\n                />\r\n            </view>\r\n        </view>\r\n    </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n    data() {\r\n        return {\r\n            deviceList: [\r\n                { id: '13012345005', name: 'DTU设备1' },\r\n                { id: '13012345001', name: 'DTU设备2' },\r\n                { id: '13912345678', name: 'DTU设备3' },\r\n                { id: '13912345679', name: 'DTU设备4' }\r\n            ],\r\n            selectedIndex: 0,\r\n            deviceStatus: {\r\n                isOnline: false,\r\n                dtuNo: '',\r\n                deviceName: '',\r\n                rcvTime: '',\r\n                voltageAB: '',\r\n                voltageBC: '',\r\n                voltageCA: '',\r\n                currentA: '',\r\n                currentB: '',\r\n                currentC: '',\r\n                energy: '',\r\n                pressure: '',\r\n                relayStatus: ''\r\n            },\r\n            timer: null,\r\n            onlineDevices: [],\r\n            isRelayLoading: false, // 添加继电器状态加载标志\r\n            localRelayStatus: '' // 添加本地继电器状态\r\n        }\r\n    },\r\n    onLoad() {\r\n        // 页面加载时开始轮询设备状态\r\n        this.startPolling()\r\n    },\r\n    onUnload() {\r\n        // 页面卸载时清除轮询\r\n        this.stopPolling()\r\n    },\r\n    watch: {\r\n        // 监听deviceStatus中的继电器状态变化\r\n        'deviceStatus.relayStatus': {\r\n            immediate: true,\r\n            handler(newVal) {\r\n                if (!this.isRelayLoading) {\r\n                    this.localRelayStatus = newVal\r\n                }\r\n            }\r\n        }\r\n    },\r\n    methods: {\r\n        onDeviceChange(e) {\r\n            this.selectedIndex = e.detail.value\r\n            // 切换设备后立即获取新设备的状态\r\n            this.getDeviceStatus()\r\n        },\r\n\r\n        startPolling() {\r\n            this.getDeviceStatus()\r\n            this.timer = setInterval(() => {\r\n                this.getDeviceStatus()\r\n            }, 2000)  // 改为2000毫秒\r\n        },\r\n\r\n        stopPolling() {\r\n            if(this.timer) {\r\n                clearInterval(this.timer)\r\n                this.timer = null\r\n            }\r\n        },\r\n        async getDeviceStatus() {\r\n            try {\r\n                const deviceId = this.deviceList[this.selectedIndex].id\r\n                \r\n                // 如果正在控制继电器，则不更新状态显示\r\n                if (this.isRelayLoading) {\r\n                    return;\r\n                }\r\n\r\n                // 先获取设备在线状态\r\n                const onlineRes = await uni.request({\r\n                    url: 'http://118.190.202.38:3000/api/online-dtus',\r\n                    method: 'GET'\r\n                })\r\n                \r\n                if(onlineRes.data.success) {\r\n                    const onlineDevices = onlineRes.data.devices.map(device => device.dtuNo)\r\n                    const isOnline = onlineDevices.includes(deviceId)\r\n                    \r\n                    // 如果设备在线，则获取详细状态\r\n                    if(isOnline) {\r\n                        const statusRes = await uni.request({\r\n                            url: `http://118.190.202.38:3000/api/dtu-status/${deviceId}`,\r\n                            method: 'GET'\r\n                        })\r\n                        \r\n                        if(statusRes.data.success && !this.isRelayLoading) {\r\n                            this.deviceStatus = {\r\n                                ...statusRes.data.data,\r\n                                isOnline\r\n                            }\r\n                        }\r\n                    } else if (!this.isRelayLoading) {\r\n                        // 如果设备离线，清空状态数据\r\n                        this.deviceStatus = {\r\n                            isOnline: false,\r\n                            dtuNo: deviceId,\r\n                            deviceName: this.deviceList[this.selectedIndex].name,\r\n                            rcvTime: '',\r\n                            voltageAB: '',\r\n                            voltageBC: '',\r\n                            voltageCA: '',\r\n                            currentA: '',\r\n                            currentB: '',\r\n                            currentC: '',\r\n                            energy: '',\r\n                            pressure: '',\r\n                            relayStatus: ''\r\n                        }\r\n                    }\r\n                }\r\n            } catch(e) {\r\n                console.error('获取设备状态失败:', e)\r\n                if (!this.isRelayLoading) {\r\n                    uni.showToast({\r\n                        title: '获取设备状态失败',\r\n                        icon: 'none'\r\n                    })\r\n                }\r\n            }\r\n        },\r\n        async toggleRelay(e) {\r\n            const status = e.detail.value\r\n            const deviceId = this.deviceList[this.selectedIndex].id\r\n            \r\n            if (!this.deviceStatus.isOnline) {\r\n                uni.showToast({\r\n                    title: '设备离线，无法控制',\r\n                    icon: 'none'\r\n                })\r\n                return\r\n            }\r\n\r\n            // 设置加载状态\r\n            this.isRelayLoading = true\r\n            // 停止轮询\r\n            this.stopPolling()\r\n            \r\n            // 保存旧状态以便恢复\r\n            const oldStatus = this.deviceStatus.relayStatus\r\n\r\n            try {\r\n                // 立即更新状态，实现即时响应\r\n                this.deviceStatus.relayStatus = status ? '闭合' : '断开'\r\n\r\n                const res = await uni.request({\r\n                    url: 'http://118.190.202.38:3000/api/control/relay',\r\n                    method: 'POST',\r\n                    data: {\r\n                        dtuNo: deviceId,\r\n                        command: status ? 'ON' : 'OFF'\r\n                    },\r\n                    header: {\r\n                        'content-type': 'application/json'\r\n                    }\r\n                })\r\n                \r\n                if(res.data.code === 0) {\r\n                    uni.showToast({\r\n                        title: '操作成功',\r\n                        icon: 'success'\r\n                    })\r\n\r\n                    // 延迟查询实际状态\r\n                    setTimeout(async () => {\r\n                        const statusRes = await uni.request({\r\n                            url: `http://118.190.202.38:3000/api/dtu-status/${deviceId}`,\r\n                            method: 'GET'\r\n                        })\r\n                        \r\n                        if(statusRes.data.success) {\r\n                            this.deviceStatus = {\r\n                                ...statusRes.data.data,\r\n                                isOnline: true\r\n                            }\r\n                        }\r\n                        \r\n                        // 最后才关闭加载状态并恢复轮询\r\n                        this.isRelayLoading = false\r\n                        this.startPolling()\r\n                    }, 1000)\r\n                } else {\r\n                    // 控制失败时恢复旧状态\r\n                    this.deviceStatus.relayStatus = oldStatus\r\n                    this.isRelayLoading = false\r\n                    this.startPolling()\r\n                    uni.showToast({\r\n                        title: res.data.message || '控制失败',\r\n                        icon: 'none'\r\n                    })\r\n                }\r\n            } catch(e) {\r\n                // 发生错误时恢复旧状态\r\n                this.deviceStatus.relayStatus = oldStatus\r\n                this.isRelayLoading = false\r\n                this.startPolling()\r\n                uni.showToast({\r\n                    title: '控制失败',\r\n                    icon: 'none'\r\n                })\r\n            }\r\n        }\r\n    }\r\n}\r\n</script>\r\n\r\n<style>\r\n.container {\r\n    padding: 20px;\r\n}\r\n\r\n.device-select {\r\n    background-color: #fff;\r\n    padding: 15px;\r\n    border-radius: 8px;\r\n    margin-bottom: 20px;\r\n}\r\n\r\n.status-panel {\r\n    background-color: #fff;\r\n    padding: 20px;\r\n    border-radius: 8px;\r\n    margin-bottom: 20px;\r\n}\r\n\r\n.status-item {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    margin-bottom: 15px;\r\n    font-size: 14px;\r\n}\r\n\r\n.online {\r\n    color: #4cd964;\r\n}\r\n\r\n.offline {\r\n    color: #dd524d;\r\n}\r\n\r\n.control-panel {\r\n    background-color: #fff;\r\n    padding: 20px;\r\n    border-radius: 8px;\r\n}\r\n\r\n.relay-item {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    padding: 10px 0;\r\n}\r\n\r\n.relay-status {\r\n    display: flex;\r\n    align-items: center;\r\n}\r\n\r\n.loading-icon {\r\n    display: inline-block;\r\n    width: 20px;\r\n    height: 20px;\r\n    border: 3px solid #f3f3f3;\r\n    border-top: 3px solid #007AFF;  /* 使用uni-app主题蓝色 */\r\n    border-radius: 50%;\r\n    animation: spin 1s linear infinite;\r\n    margin-left: 10px;\r\n    vertical-align: middle;\r\n}\r\n\r\n@keyframes spin {\r\n    0% { transform: rotate(0deg); }\r\n    100% { transform: rotate(360deg); }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'G:/桌面/app6/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","e"],"mappings":"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"}